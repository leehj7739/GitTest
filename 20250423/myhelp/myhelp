#!/bin/bash

# myhelp - ëª…ë ¹ì–´ ì‹¤í–‰ ê²°ê³¼ë¥¼ AIë¡œ ë¶„ì„í•˜ëŠ” ë„ìš°ë¯¸ í”„ë¡œê·¸ë¨
# ë²„ì „: 1.0
# ì‘ì„±ì¼: 2024-04-23

# ìƒ‰ìƒ ì •ì˜
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# êµ¬ë¶„ì„  í•¨ìˆ˜
print_separator() {
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# ë¡œê·¸ íŒŒì¼ ê²½ë¡œ ì„¤ì •
LOG_DIR="/tmp"
OUT_LOG="${LOG_DIR}/myhelp_output.log"
ERR_LOG="${LOG_DIR}/myhelp_error.log"

# ë¡œê·¸ íŒŒì¼ ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ìƒì„±)
[ ! -f "$OUT_LOG" ] && touch "$OUT_LOG"
[ ! -f "$ERR_LOG" ] && touch "$ERR_LOG"

# OpenAI API í‚¤ ì„¤ì •
if [ -z "${OPENAI_API_KEY}" ]; then
    OPENAI_API_KEY="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"
fi

# API í‚¤ í™•ì¸
if [ -z "${OPENAI_API_KEY}" ]; then
    echo "ì˜¤ë¥˜: OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    exit 1
fi

# ì‚¬ìš©ë²• ì¶œë ¥ í•¨ìˆ˜
show_usage() {
    echo "ì‚¬ìš©ë²•: myhelp [ì˜µì…˜] [ëª…ë ¹ì–´]"
    echo "ì˜µì…˜:"
    echo "  -h    ë„ì›€ë§ í‘œì‹œ"
    echo "  -v    ìƒì„¸ ë¶„ì„ ëª¨ë“œ (ìµœëŒ€ 3ê°€ì§€ í•´ê²°ì±… ì œì•ˆ)"
    echo ""
    echo "ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰í•œ ëª…ë ¹ì–´ì˜ ê²°ê³¼ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤."
    exit 0
}

# AI ë¶„ì„ í•¨ìˆ˜
analyze_with_ai() {
    local cmd="$1"
    local output="$2"
    local verbose="$3"
    
    local prompt
    if [ "$verbose" = "true" ]; then
        prompt="ë‹¤ìŒ ëª…ë ¹ì–´ì™€ ê·¸ ì¶œë ¥ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  ìµœëŒ€ 3ê°€ì§€ í•´ê²°ì±…ì„ ì œì•ˆí•´ì£¼ì„¸ìš”. ê° í•­ëª©ì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œí•´ì£¼ì„¸ìš”:\n\nëª…ë ¹ì–´: $cmd\n\nì¶œë ¥:\n$output"
    else
        prompt="ë‹¤ìŒ ëª…ë ¹ì–´ì™€ ê·¸ ì¶œë ¥ ê²°ê³¼ë¥¼ ê°„ë‹¨íˆ ìš”ì•½í•´ì„œ ë¶„ì„í•´ì£¼ì„¸ìš” (2-3ì¤„ ì´ë‚´):\n\nëª…ë ¹ì–´: $cmd\n\nì¶œë ¥:\n$output"
    fi

    # JSON ë°ì´í„° ì¤€ë¹„
    local json_data
    json_data=$(jq -n \
        --arg prompt "$prompt" \
        '{
            model: "gpt-4-turbo-preview",
            messages: [{role: "user", content: $prompt}],
            stream: true
        }')

    print_separator
    echo -e "\n${BOLD}ğŸ¤– ë¶„ì„ ê²°ê³¼${NC}\n"
    print_separator
    echo

    # OpenAI API ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
    curl -s "https://api.openai.com/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $OPENAI_API_KEY" \
        -d "$json_data" | while read -r line; do
            if [[ $line == data:* ]]; then
                content=$(echo "$line" | sed 's/^data: //' | jq -r '.choices[0].delta.content // empty' 2>/dev/null)
                if [ ! -z "$content" ]; then
                    echo -n "$content"
                fi
            fi
        done

    echo -e "\n"
    print_separator
    echo
}

# ì˜µì…˜ ì²˜ë¦¬
verbose=false
while getopts "hv" opt; do
    case $opt in
        h)
            show_usage
            ;;
        v)
            verbose=true
            ;;
        \?)
            echo "ì˜ëª»ëœ ì˜µì…˜ì…ë‹ˆë‹¤: -$OPTARG" >&2
            show_usage
            ;;
    esac
done
shift $((OPTIND-1))

# ëª…ë ¹ì–´ ì‹¤í–‰ ë° ë¶„ì„
if [ $# -eq 0 ]; then
    # ë§ˆì§€ë§‰ ëª…ë ¹ì–´ ë¶„ì„
    if [ -f "$OUT_LOG" ]; then
        # ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹¤í–‰ëœ ëª…ë ¹ì–´ì™€ ì¶œë ¥ ê°€ì ¸ì˜¤ê¸°
        last_cmd=$(tail -n 2 "$OUT_LOG" | head -n 1)
        last_output=$(tail -n 1 "$OUT_LOG")
        if [ -z "$last_cmd" ] || [[ "$last_cmd" == "myhelp"* ]]; then
            echo -e "${YELLOW}âš ï¸ ì´ì „ ëª…ë ¹ì–´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.${NC}"
            exit 1
        fi
        echo -e "${GREEN}ğŸ” ë§ˆì§€ë§‰ ëª…ë ¹ì–´ ë¶„ì„ ì¤‘: ${BOLD}$last_cmd${NC}"
        analyze_with_ai "$last_cmd" "$last_output" "$verbose"
    else
        echo -e "${YELLOW}âš ï¸ ì´ì „ ëª…ë ¹ì–´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.${NC}"
        exit 1
    fi
else
    # ìƒˆ ëª…ë ¹ì–´ ì‹¤í–‰ ë° ë¶„ì„
    cmd="$*"
    # ëª…ë ¹ì–´ ì‹¤í–‰ ë° ê²°ê³¼ ì €ì¥
    output=$($cmd 2>&1)
    # ëª…ë ¹ì–´ì™€ ì¶œë ¥ì„ ë¡œê·¸ì— ì €ì¥
    echo "$cmd" >> "$OUT_LOG"
    echo "$output" >> "$OUT_LOG"
    # ê²°ê³¼ ì¶œë ¥
    echo -e "${GREEN}ğŸ“‹ ì‹¤í–‰ ê²°ê³¼:${NC}\n"
    echo "$output"
    echo -e "\n${GREEN}ğŸ” ëª…ë ¹ì–´ ë¶„ì„ ì¤‘...${NC}"
    analyze_with_ai "$cmd" "$output" "$verbose"
fi
